!function(e,t){for(var a in t)e[a]=t[a]}(exports,function(e){var t={};function a(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,a),r.l=!0,r.exports}return a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(n,r,function(t){return e[t]}.bind(null,r));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=2)}([function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("firebase-admin")},function(e,t,a){"use strict";let n,r,s;a.r(t),a.d(t,"handler",(function(){return V})),function(e){e.UNAPPROVED="Unapproved",e.PENDING="Pending",e.APPROVED="Approved",e.REJECTED="Rejected"}(n||(n={})),function(e){e.SIGN_UP="Signing up",e.VERIFY="Verification",e.TINDER="Match Making"}(r||(r={})),function(e){e.PDPA="PDPA",e.PDPA_CALLBACK="PDPA Verification",e.PROGRAMMES="Adding Programmes",e.VERIFICATION_REQUEST="Verification Request",e.VERIFICATION_RESPONSE="Verification Response",e.APPROVING="Approval"}(s||(s={}));var o=a(1),i=a.n(o);const c={projectId:process.env.FIREBASE_PROJECT_ID,privateKey:process.env.FIREBASE_PRIVATE_KEY,clientEmail:process.env.FIREBASE_CLIENT_EMAIL};i.a.initializeApp({credential:i.a.credential.cert(c)});const u=e=>i.a.firestore().collection(e).withConverter({toFirestore:e=>e,fromFirestore:e=>e.data()}),d={users:u("users"),tempMsgs:u("temp_msgs"),contentPage:u("content_page"),statics:u("statics"),default:i.a.firestore()};async function p(e){const t=await d.users.doc(e).get();return t.exists?t.data():null}async function l(e){const t=await d.users.doc(e).get();return t.exists?t.data().state:null}async function f(e,t){return d.users.doc(e).update({state:JSON.parse(JSON.stringify(t))})}async function m(){const e=await d.contentPage.doc("content_page").get();return e.exists?e.data():null}var g=a(0),E=a.n(g);function _(e){return e.response&&"Not Found"==e.response.data.description?{errorCode:1}:e.response&&"Bad Request: message to delete not found"==e.response.data.description?{errorCode:2}:e.response&&"Bad Request: message to edit not found"==e.response.data.description?{errorCode:3}:e.response&&"Bad Request: message can't be edited"==e.response.data.description?{errorCode:4}:e.response&&"Bad Request: chat_id is empty"==e.response.data.description?{errorCode:5}:e.response&&"Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message"==e.response.data.description?{errorCode:6}:e.response&&"Forbidden: bot was blocked by the user"==e.response.data.description?{errorCode:7}:{errorCode:0,errorDescription:e.response.data.description}}const h="https://api.telegram.org/bot";async function P(e,t,a,n){return new Promise((r,s)=>{E.a.post(h+e+"/answerCallbackQuery",{callback_query_id:t,text:a,show_alert:n}).then(e=>{console.log("Callback "+t),r(e.data)}).catch(e=>{let t=_(e);t.errorDescription="default",s(t)})})}async function I(e,t,a,n={}){return new Promise((r,s)=>{E.a.post(h+e+"/sendMessage",{chat_id:t,text:a,parse_mode:"HTML",reply_markup:n}).then(e=>{const t=e.data.result;console.log(`Message posted (id: ${t.message_id})`),r(e.data)}).catch(e=>{s(_(e))})})}function R(e,t){for(var a=[],n=0,r=0;r<e.length;++r){var s=[];for(var o of e[r])s.push({text:o,callback_data:t[n]}),n+=1;a.push(s)}return{inline_keyboard:a}}async function S(e,t,a,n,r={}){return new Promise((s,o)=>{E.a.post(h+e+"/editMessageText",{chat_id:t,message_id:a,text:n,parse_mode:"HTML",reply_markup:r}).then(e=>{console.log(`Message Updated (id: ${e.data.result.message_id})`),s(e.data)}).catch(e=>{o(_(e))})})}async function y(e,t,a,n,r={}){return new Promise((s,o)=>{E.a.post(h+e+"/sendPhoto",{chat_id:t,photo:a,caption:n,parse_mode:"HTML",reply_markup:r}).then(e=>{const t=e.data.result;console.log(`Photo posted (id: ${t.message_id})`),s(e.data)}).catch(e=>{o(_(e))})})}async function b(e,t,a,n,r={}){return new Promise((s,o)=>{E.a.post(h+e+"/sendDocument",{chat_id:t,document:a,caption:n,reply_markup:r}).then(e=>{const t=e.data.result;console.log(`Document posted (id: ${t.message_id})`),s(t)}).catch(e=>{o(_(e))})})}function A(e,t){return t+=`<a href="tg://metadata/${JSON.stringify(e).split('"').join("'")}/end">â€‹</a>`}const w=process.env.TELE_BOT_KEY;async function O(e,t,a,o){const i=M(a.text,a.entities),c=a.message_id,u=await async function(e){const t=await d.statics.doc(e).get();if(t.exists)switch(e){case r.SIGN_UP:return t.data();case r.VERIFY:case r.TINDER:default:return}}(r.SIGN_UP);switch(t.stateStage){case s.PDPA:return async function(e,t){const a=function(e,t){const a=(o=r.SIGN_UP,i=s.PDPA_CALLBACK,{protocol:o,stateStage:i,stateData:null});var o,i;return{id:e.toString(),state:a,name:t,status:n.UNAPPROVED,swiperQueue:[],programmes:[],hobbies:[],interests:[]}}(t.id,t.first_name);let o=e.PDPA;const i=R([["Accept","Decline"]],["Accept","Decline"]);return await async function(e){return d.users.doc(e.id).set(e)}(a),C(t.id,o,i)}(u,e);case s.PDPA_CALLBACK:return async function(e,t,a,n,r,o){if("Accept"==o[0]){r+="\n\nYou have <b>accepted</b> the agreement",await S(w,a.id,n,r),t.stateStage=s.PROGRAMMES,await f(a.id.toString(),t);const o=R([e.PROGRAMMES],e.PROGRAMMES.map((e,t)=>t.toString()));return C(a.id,e.ADD_PROGRAMMES,o)}await S(w,a.id,n,e.PDPA_DECLINED)}(u,t,e,c,i,o);case s.PROGRAMMES:return async function(e,t,a,n,r){let o=await p(t.id.toString());const i=e.PROGRAMMES,c=parseInt(r[0]),u=i[c];if("Done"==u)return await S(w,t.id,a,n),o.state.stateStage=s.VERIFICATION_REQUEST,await f(o.id,o.state),await C(t.id,e.VERIFICATION);"Clear"==u?o.programmes=[]:o.programmes.includes(u)?o.programmes=o.programmes.filter(e=>e==u):o.programmes.push(u);await async function(e,t){return d.users.doc(e).update({programmes:t})}(o.id,o.programmes),n=e.ADD_PROGRAMMES,o.programmes.forEach(e=>n+=` - ${e}\n`);const l=R([e.PROGRAMMES],e.PROGRAMMES.map((e,t)=>t.toString()));return S(w,t.id,a,n,l)}(u,e,c,i,o);case s.VERIFICATION_REQUEST:return async function(e,t,a){if(!a.document&&!a.photo)return C(t.id,e.VERIFICATION);await C(t.id,e.VERIFICATION_RECEIVED),await async function(e,t){return d.users.doc(e).update({status:t})}(t.id.toString(),n.PENDING);const o=await p(t.id.toString()),i=await async function(){return(await m()).admins}();if(null==o)return async function(e,t,a={}){let n=[];e.forEach(e=>{n.push(C(parseInt(e),t,a))}),await Promise.all(n)}(i,`Error obtaining User ${o.username} for Verification`);o.state.stateStage=s.VERIFICATION_RESPONSE,await f(o.id,o.state);var c="<b>ðŸ“¬ New User!</b>\n\n<b>Name:</b> "+o.name+"\n<b>Username:</b> @"+o.username+"\n<b>Programmes:</b> \n";for(let e of o.programmes)c+="\n - "+e;const u={protocol:r.SIGN_UP,stage:s.VERIFICATION_RESPONSE,data:o.id};c=A(u,c);const l=R([["Accept","Reject"]],["Accept","Reject"]);for(let e of i)a.document?await b(w,e,a.document.file_unique_id,c,l):a.photo&&await y(w,e,a.photo[0].file_unique_id,c,l)}(u,e,a);case s.VERIFICATION_RESPONSE:return async function(e,t,a,o,i){const c=o.stateData;let u=await p(c),l=M(a.text,a.entities);if(u.status!=n.PENDING){let e=await p(u.verifierId);return S(w,a.chat.id,a.message_id,l+`This user has already been ${u.status} by @${null!=e?e.username:"unknown"}`)}if(u.state.protocol!=r.SIGN_UP||u.state.stateStage!=s.VERIFICATION_RESPONSE)return S(w,a.chat.id,a.message_id,l+"The user has withdrawn his application");const f=i[0];"Accept"==f?(u.status=n.APPROVED,u.verifierId=t.id.toString(),l+=`\n\n<b>Approved by: @${t.username}</b>`,await C(u.id,e.VERIFICATION_APPROVED)):"Reject"==f&&(u.status=n.REJECTED,u.verifierId=t.id.toString(),l+=`\n\n<b>Rejected by: @${t.username}</b>`,await C(u.id,e.VERIFICATION_REJECTED));u.state=null,await async function(e,t){return d.users.doc(e).update(t)}(u.id,u),await S(w,a.chat.id,a.message_id,l)}(u,e,a,t,o)}}const N=process.env.TELE_BOT_KEY;async function D(e){let t=M(e.text,e.entities);if(t.indexOf("/")>=0)return async function(e,t){if(t.from.id!==t.chat.id){const e=function(e,t,a){for(var n=[],r=0,s=0;s<e.length;++s){var o=[];for(var i of e[s])o.push({text:i,callback_data:t[r],url:a[r]}),r+=1;n.push(o)}return{inline_keyboard:n}}([["Go to Bot"]],["group-link"],["https://t.me/sanbox_penpal_tbot"]);return C(t.chat.id,"Sorry, this bot does not work in groups",e)}if(T("/start",e)||T("/register",e)){const e={protocol:r.SIGN_UP,stateStage:s.PDPA,stateData:null};return O(t.from,e,t)}if(T("/identify",e))return C(t.chat.id,t.chat.id.toString());if(!T("/test",e))return C(t.from.id,"Unrecognized command")}(t,e);if(e.from.id!==e.chat.id)return;const a=await l(e.from.id.toString());if(a)switch(a.protocol){case r.SIGN_UP:return O(e.from,a,e);case r.VERIFY:case r.TINDER:}}async function v(e){const t=(a=M(e.message.text,e.message.entities),(n=a.split("tg://metadata/")[1])?(n=(n=n.split("/end")[0]).split("'").join('"'),JSON.parse(n.split("/end")[0])):null);var a,n;let s;if(t)s={protocol:t.protocol,stateStage:t.stage,stateData:t.data};else if(s=await l(e.from.id.toString()),!s)return P(N,e.id,"Incorrect state",!1);const o=e.data?e.data.split("<>"):null;switch(s.protocol){case r.SIGN_UP:return O(e.from,s,e.message,o);case r.VERIFY:case r.TINDER:}await P(N,e.id,"Thank you",!1)}function T(e,t){return t.indexOf(e)>=0}async function C(e,t,a={}){await I(N,e,t,a)}function M(e,t){return e?(e=(e=function(e){if(e)return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}(e)).replace(/\"/g,"'"),t&&(e=function(e,t){if(!t)return e;var a=[];for(o of t)a.push(Object.values(o));a.sort((function(e,t){return e[0]==t[0]?e[1]-t[1]:e[0]-t[0]}));var n=[],r="",s="";for(var o of a){switch(o[2]){case"bold":r="<b>",s="</b>";break;case"italic":r="<i>",s="</i>";break;case"underline":r="<u>",s="</u>";break;case"code":r="<code>",s="</code>";break;case"strikethrough":r="<s>",s="</s>";break;case"text_link":r='<a href="'+o[3]+'">',s="</a>";break;default:r="",s=""}for(var i=o[0],c=o[0]+o[1],u=i,d=c,p=0;p<n.length;++p){var l=n[p];(i>l[0]||i==l[0]&&"tail"==l[2])&&(u+=l[1].length),(c>l[0]||c==l[0]&&i==n[p-1][0])&&(d+=l[1].length)}var f=e;f=e.slice(0,u)+r,f+=e.slice(u,d)+s,f+=e.slice(d),e=f,n.push([i,r,"head"]),n.push([c,s,"tail"])}return e}(e,t)),e):"empty"}const k=process.env.TELE_BOT_KEY;async function V(e,t){switch(e.httpMethod){case"POST":const t=JSON.parse(e.body);await async function(e){e.message?await D(e.message):e.callback_query&&await v(e.callback_query)}(t);break;case"GET":await m();const a=A({function:"test",hello:123},"Sup nothing to see here");await I(k,90554672,a)}return{statusCode:200,body:"done"}}}]));